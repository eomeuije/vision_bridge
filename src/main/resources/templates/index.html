<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Bridge</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>
<body>

<!-- 로고, 제목, 사용법 버튼 영역 -->
<div class="header d-flex align-items-center justify-content-between">
    <!-- 로고 영역 -->
    <div class="logo" aria-hidden="true">
        <i class="fa-solid fa-eye logo-icon"></i>
    </div>

    <!-- 제목 영역 -->
    <h1 id="mainTitle" tabindex="1">Vision Bridge</h1>

    <!-- 사용법 버튼 -->
    <button id="helpButton" class="btn help-button" aria-label="Vision Bridge 사용법 보기" tabindex="2">
        <i class="fa-regular fa-circle-question"></i> 사용법
    </button>
</div>

<!-- 입출력 영역 -->
<div class="container">
    <div class="translator-container">
        <!-- 텍스트 입력 영역 -->
        <div class="translator-area">
            <h4>
                <span class="lang-toggle active" id="brailleTab" role="tab" aria-selected="true" aria-controls="inputText" tabindex="3">점자</span>
                <span class="lang-toggle" id="textTab" role="tab" aria-selected="false" aria-controls="inputText" tabindex="4">비점자</span>
            </h4>
            <textarea id="inputText" class="form-control" rows="7" placeholder="점자를 입력하세요. 또는 문서/이미지를 드래그 앤 드롭하세요." aria-label="번역 입력창" tabindex="5"></textarea>

            <div class="file-upload">
                <!-- 이미지 업로드 버튼 -->
                <button class="shared-button" id="imageUploadButton" aria-label="이미지 파일 업로드" onclick="document.getElementById('imageUpload').click()" tabindex="11">
                    <i class="fa-regular fa-image"></i> 점자 이미지 업로드
                </button>
                <input type="file" id="imageUpload" accept="image/*" enctype="multipart/form-data" style="display: none;">
                <!-- 문서 업로드 버튼 -->
                <button class="shared-button" id="documentUploadButton" aria-label="문서 파일 업로드" onclick="document.getElementById('documentUpload').click()" tabindex="12">
                    <i class="fa-regular fa-folder-open"></i> 점자 문서 업로드
                </button>
                <input type="file" id="documentUpload" style="display: none;">
            </div>
        </div>

        <!-- 양방향 화살표 -->
        <div class="arrow-area">
            <i class="arrow-icon fa-solid fa-arrow-right-arrow-left" id="translateArrow" role="button" aria-label="번역 방향 변경" tabindex="6"></i>
            <button id="translateButton" class="btn btn-primary translate-button" aria-label="번역 실행" tabindex="7">번역</button>
        </div>

        <!-- 텍스트 출력 영역 -->
        <div class="translator-area">
            <h4>
                <span class="lang-toggle" id="brailleToText" role="tab" aria-selected="false" aria-controls="outputText" tabindex="8">점자</span>
                <span class="lang-toggle active" id="textToBraille" role="tab" aria-selected="true" aria-controls="outputText" tabindex="9">비점자</span>
            </h4>
            <textarea id="outputText" class="form-control" rows="7" readonly placeholder="번역 결과가 비점자로 표시됩니다." aria-label="번역 결과창" tabindex="10"></textarea>

            <div class="action-buttons">
                <!-- BRF 다운로드 버튼 -->
                <button id="downloadButton" class="shared-button" aria-label="BRF 파일 다운로드" tabindex="13">
                    <i class="fa-regular fa-circle-down"></i> BRF 다운로드
                </button>
                <!-- 음성 출력 버튼 -->
                <button id="voiceButton" class="shared-button" aria-label="번역 결과 음성 출력" tabindex="14">
                    <i class="fa-solid fa-play"></i> 번역 결과 음성 출력
                </button>
            </div>
            <!-- 음성 속도 버튼 -->
            <div class="voice-settings">
                <label for="voiceRate">
                    <i class="fa-solid fa-tachometer-alt"></i> 음성 속도:
                </label>
                <select id="voiceRate" class="form-select">
                    <option value="0.5">느림 (0.5x)</option>
                    <option value="1" selected>보통 (1x)</option>
                    <option value="1.5">빠름 (1.5x)</option>
                    <option value="2">매우 빠름 (2x)</option>
                </select>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.11/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    let isBrailleToText = true;

    const brailleTab = document.getElementById('brailleTab');
    const textTab = document.getElementById('textTab');
    const inputText = document.getElementById('inputText');
    const outputText = document.getElementById('outputText');
    const translateArrow = document.getElementById('translateArrow');

    // 번역 방향 변경 (클릭 및 엔터 키)
    translateArrow.addEventListener('click', function () {
        // 상태 토글
        isBrailleToText = !isBrailleToText;

        // 입력 영역 탭 활성화 및 색상 변경
        brailleTab.classList.toggle('active', isBrailleToText);
        textTab.classList.toggle('active', !isBrailleToText);
        brailleTab.setAttribute('aria-selected', isBrailleToText);
        textTab.setAttribute('aria-selected', !isBrailleToText);

        // 출력 영역 탭 활성화 및 색상 변경
        const brailleToText = document.getElementById('brailleToText');
        const textToBraille = document.getElementById('textToBraille');
        brailleToText.classList.toggle('active', !isBrailleToText);
        textToBraille.classList.toggle('active', isBrailleToText);
        brailleToText.setAttribute('aria-selected', !isBrailleToText);
        textToBraille.setAttribute('aria-selected', isBrailleToText);

        // 입력 및 출력 플레이스홀더 전환
        inputText.placeholder = isBrailleToText
            ? "점자를 입력하세요.   또는 문서/이미지를 드래그 앤 드롭하세요."
            : "비점자를 입력하세요. 또는 문서/이미지를 드래그 앤 드롭하세요.";
        outputText.placeholder = isBrailleToText
            ? "번역 결과가 비점자로 표시됩니다."
            : "번역 결과가 점자로 표시됩니다.";

        // 입력 및 출력 값 초기화
        inputText.value = '';
        outputText.value = '';

        // 버튼 업데이트
        updateImageUploadButton();
        updateDocumentUploadButton();
    });

    // 엔터 키로 번역 방향 변경
    translateArrow.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // 기본 동작 방지
            this.click(); // 클릭 이벤트 트리거
        }
    });

    // 번역 버튼 동작
    document.getElementById('translateButton').addEventListener('click', function () {
        const inputValue = document.getElementById('inputText').value;

        if (!inputValue) {
            alert('입력 텍스트가 비어 있습니다.');
            return;
        }

        // API 호출
        const endpoint = isBrailleToText ? '/translate/toText' : '/translate/toBraille';
        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(isBrailleToText ? { brailleText: inputValue } : { sourceText: inputValue }),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`번역 실패: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('outputText').value = data; // 번역 결과 출력
            })
            .catch(error => {
                console.error('번역 중 오류 발생:', error);
                alert(`번역 중 오류 발생: ${error.message}`);
            });
    });

    // 이미지 업로드 버튼 상태 업데이트 함수
    function updateImageUploadButton() {
        const imageUploadButton = document.getElementById('imageUploadButton'); // 고유 id로 접근
        if (imageUploadButton) {
            imageUploadButton.innerHTML = isBrailleToText
                ? '<i class="fa-regular fa-image"></i> 점자 이미지 업로드'
                : '<i class="fa-regular fa-image"></i> 비점자 이미지 업로드';
            imageUploadButton.setAttribute('aria-label', isBrailleToText
                ? '점자 이미지 파일 업로드'
                : '비점자 이미지 파일 업로드');
            // console.log("버튼 상태 업데이트 완료:", isBrailleToText ? "점자" : "비점자");
        } else {
            // console.error("이미지 업로드 버튼을 찾을 수 없습니다.");
        }
    }

    // 사용법 버튼
    document.getElementById('helpButton').addEventListener('click', function () {
        window.open('/help', '_blank', 'width=600,height=400');
    });

    const inputTextElement = document.getElementById('inputText');

    inputTextElement.addEventListener('dragover', (event) => {
        event.preventDefault();  // 기본 동작 방지
        inputTextElement.style.backgroundColor = "#e0e0e0";  // 드래그 중 배경색 변경
    });

    // 드래그 종료 후 배경색 원래대로
    inputTextElement.addEventListener('dragleave', () => {
        inputTextElement.style.backgroundColor = "";
    });

    // 파일 드랍시 이벤트
    inputTextElement.addEventListener('drop', (event) => {
        event.preventDefault();  // 기본 동작 방지
        inputTextElement.style.backgroundColor = "";  // 배경색 원래대로
        const file = event.dataTransfer.files[0];  // 드롭된 파일 가져오기
        type = '';
        if (!file.type) {
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension === 'pdf') {
                type = 'application/pdf';  // 수동으로 텍스트 파일 타입 설정
            } else if (['hwp'].includes(fileExtension)) {
                type = 'application/x-hwp';
            } else if (['docx'].includes(fileExtension)) {
                type = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
            } else if (['brf', 'text'].includes(fileExtension)) {
                type = 'application/octet-stream';
            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                type = 'image/' + fileExtension;  // 이미지 파일 타입 설정
            }
        }

        // 파일이 텍스트 파일인 경우
        if (file && file.type.startsWith('application/') || type.startsWith('application/')) {
            documentUploadEvent(file);
        }
        // 파일이 이미지 파일인 경우
        else if (file && file.type.startsWith('image/') || type.startsWith('image/')) {
            imageUploadEvent(file);
        } else {
            alert("지원되지 않는 파일 형식입니다.");
        }
    });

    function imageUploadEvent(file, event) {
        // 번역 방향에 따른 Spring 컨트롤러 경로
        const endpoint = isBrailleToText
            ? '/api/brailleImg'  // 점자 이미지를 텍스트로 변환
            : '/ocr';            // OCR 작업 수행

        const formData = new FormData();
        formData.append("file", file);

        fetch(endpoint, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Spring 서버와의 통신 오류: ${response.statusText}`);
                }
                return response.json(); // JSON 응답 처리
            })
            .then(data => {
                // 번역 방향에 따라 처리 결과 출력
                if (isBrailleToText && data.braille_text) {
                    document.getElementById('inputText').value = data.braille_text.join('\n'); // 점자 → 텍스트
                } else if (!isBrailleToText && data.text) {
                    document.getElementById('inputText').value = data.text; // 텍스트 → 점자
                } else {
                    alert("변환 결과를 가져올 수 없습니다.");
                }
            })
            .catch(error => {
                console.error("Spring 서버 요청 중 오류 발생:", error);
                alert(`Spring 서버 요청 중 오류 발생: ${error.message}`);
            })
            .finally(() => {
                if (event) event.target.value = ""; // 파일 입력 초기화
            });
    }

    // 이미지 업로드
    document.getElementById('imageUpload').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) {
            alert("이미지를 선택해주세요.");
            return;
        }
        imageUploadEvent(file, event);
    });

    // 문서 업로드
    document.getElementById('documentUpload').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            alert(`문서 파일 선택: ${file.name}`);
        }
    });

    function documentUploadEvent(file, event) {
        // 번역 방향에 따른 서버 엔드포인트 설정
        const endpoint = isBrailleToText ? '/document/braille' : '/document/text';
        console.log(`서버로 요청 보냄: ${endpoint}`);

        const formData = new FormData();
        formData.append("file", file);

        fetch(endpoint, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`업로드 실패: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                console.log("서버 응답 데이터:", data);
                alert("문서 업로드 및 처리 완료!");
                document.getElementById('inputText').value = data;
            })
            .catch(error => {
                console.error("업로드 중 오류 발생:", error.message);
                alert(`업로드 중 오류 발생: ${error.message}`);
            })
            .finally(() => {
                if (event) event.target.value = ''; // 파일 입력 초기화
            });
    }

    // 문서 업로드
    document.getElementById('documentUpload').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) {
            console.error("파일이 선택되지 않았습니다.");
            return;
        }
        documentUploadEvent(file, event);
    });

    function updateDocumentUploadButton() {
        const documentUploadButton = document.getElementById('documentUploadButton');
        const documentUploadInput = document.getElementById('documentUpload');

        if (documentUploadButton && documentUploadInput) {
            if (isBrailleToText) {
                // 점자 → 비점자
                documentUploadButton.innerHTML = '<i class="fa-regular fa-folder-open"></i> 점자 문서 업로드';
                documentUploadButton.setAttribute('aria-label', '점자 문서 파일 업로드');
                documentUploadInput.setAttribute('accept', '.brf');
            } else {
                // 비점자 → 점자
                documentUploadButton.innerHTML = '<i class="fa-regular fa-folder-open"></i> 비점자 문서 업로드';
                documentUploadButton.setAttribute('aria-label', '비점자 문서 파일 업로드');
                documentUploadInput.setAttribute('accept', '.pdf,.hwp,.docx,.txt');
            }
        } else {
            console.error("문서 업로드 버튼 또는 입력 요소를 찾을 수 없습니다.");
        }
    }

    // BRF 다운로드 버튼
    document.getElementById('downloadButton').addEventListener('click', function () {
        const content = outputText.value;
        if (!content) {
            alert('다운로드할 내용이 없습니다.');
            return;
        }
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'translated.brf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    // 음성 출력 버튼
    document.getElementById('voiceButton').addEventListener('click', function () {
        const text = document.getElementById('outputText').value; // 출력 텍스트 가져오기
        const rate = parseFloat(document.getElementById('voiceRate').value); // 선택된 음성 속도
        console.log('선택된 음성 속도:', rate);

        if (text) {
            const speech = new SpeechSynthesisUtterance(text);
            speech.lang = 'ko-KR';
            speech.rate = rate; // 사용자 선택 속도 적용
            console.log('적용된 음성 속도:', speech.rate);
            window.speechSynthesis.speak(speech);
        } else {
            alert('번역 결과가 없습니다.');
        }
    });


</script>
</body>
</html>
