<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Bridge</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>
<body>

<!-- 로고, 제목, 사용법 버튼 영역 -->
<div class="header d-flex align-items-center justify-content-between">
    <!-- 로고 영역 -->
    <div class="logo" aria-hidden="true">
        <i class="fa-solid fa-eye logo-icon"></i>
    </div>

    <!-- 제목 영역 -->
    <h1 id="mainTitle" tabindex="1">Vision Bridge</h1>

    <!-- 사용법 버튼 -->
    <button id="helpButton" class="btn help-button" aria-label="Vision Bridge 사용법 보기" tabindex="2">
        <i class="fa-regular fa-circle-question"></i> 사용법
    </button>
</div>

<!-- 입출력 영역 -->
<div class="container">
    <div class="translator-container">
        <!-- 텍스트 입력 영역 -->
        <div class="translator-area">
            <h4>
                <span class="lang-toggle active" id="brailleTab" role="tab" aria-selected="true" aria-controls="inputText" tabindex="3">점자</span>
                <span class="lang-toggle" id="textTab" role="tab" aria-selected="false" aria-controls="inputText" tabindex="4">비점자</span>
            </h4>

            <!-- 입력 필드 -->
            <textarea id="inputText" class="form-control" rows="7" placeholder="점자를 입력하세요. 또는 문서/이미지를 드래그 앤 드롭하세요." aria-label="번역 입력창" tabindex="5"></textarea>

            <div style="text-align:right;">
                <!-- 점자 키보드 버튼 -->
                <button id="openKeyboard" style="" class="btn btn-primary virtual-keyboard-btn">점자 키보드</button>
                <!-- 점자 키보드 팝업 -->
                <div id="brailleKeyboardPopup" class="keyboard-popup">
                    <div class="popup-content">
                        <h4>가상 점자 키보드</h4>
                        <div class="grid-container">
                            <div class="hole" id="hole1"></div>
                            <div class="hole" id="hole2"></div>
                            <div class="hole" id="hole3"></div>
                            <div class="hole" id="hole4"></div>
                            <div class="hole" id="hole5"></div>
                            <div class="hole" id="hole6"></div>
                        </div>
                        <div class="keyboard-buttons">
                            <button class="btn btn-danger" onclick="resetBraille()">초기화</button>
                            <button class="btn btn-success" onclick="generateBraille()">입력</button>
                            <button class="btn btn-secondary" onclick="closeKeyboard()">닫기</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="file-upload">
                <!-- 이미지 업로드 버튼 -->
                <button class="shared-button" id="imageUploadButton" aria-label="이미지 파일 업로드" onclick="document.getElementById('imageUpload').click()" tabindex="11">
                    <i class="fa-regular fa-image"></i> 점자 이미지 업로드
                </button>
                <input type="file" id="imageUpload" accept="image/*" enctype="multipart/form-data" style="display: none;">
                <!-- 문서 업로드 버튼 -->
                <button class="shared-button" id="documentUploadButton" aria-label="문서 파일 업로드" onclick="document.getElementById('documentUpload').click()" tabindex="12">
                    <i class="fa-regular fa-folder-open"></i> 점자 문서 업로드
                </button>
                <input type="file" id="documentUpload" style="display: none;">
            </div>
        </div>

        <!-- 양방향 화살표 -->
        <div class="arrow-area">
            <i class="arrow-icon fa-solid fa-arrow-right-arrow-left" id="translateArrow" role="button" aria-label="번역 방향 변경" tabindex="6"></i>
            <button id="translateButton" class="btn btn-primary translate-button" aria-label="번역 실행" tabindex="7">번역</button>
        </div>

        <!-- 텍스트 출력 영역 -->
        <div class="translator-area">
            <h4>
                <span class="lang-toggle" id="brailleToText" role="tab" aria-selected="false" aria-controls="outputText" tabindex="8">점자</span>
                <span class="lang-toggle active" id="textToBraille" role="tab" aria-selected="true" aria-controls="outputText" tabindex="9">비점자</span>
            </h4>
            <textarea id="outputText" class="form-control" rows="7" readonly placeholder="번역 결과가 비점자로 표시됩니다." aria-label="번역 결과창" tabindex="10"></textarea>

            <div class="action-buttons">
                <!-- BRF 다운로드 버튼 -->
                <button id="downloadButton" class="shared-button" aria-label="BRF 파일 다운로드" tabindex="13" style="visibility: hidden;">
                    <i class="fa-regular fa-circle-down"></i> BRF 다운로드
                </button>
                <!-- tts-->
                <div class="output-header">
                    <h4>번역 결과 음성 출력</h4>
                </div>
                <!-- 음성 진행률 바 (음악 앱 스타일) -->
                <div class="tts-progress-container">
                    <span id="ttsCurrentTime">00:00</span>
                    <input type="range" id="ttsSeekBar" min="0" max="100" value="0" step="1">
                    <span id="ttsTotalTime">00:00</span>
                </div>

                <!-- 음성 컨트롤 버튼 -->
                <div class="tts-controls">
                    <button id="resetButton" class="tts-button">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                    <button id="rewindButton" class="tts-button">
                        <i class="fa-solid fa-backward"></i>
                    </button>
                    <button id="playPauseButton" class="tts-button">
                        <i class="fa-solid fa-play"></i>
                    </button>
                    <button id="skipButton" class="tts-button">
                        <i class="fa-solid fa-forward"></i>
                    </button>
                    <select id="voiceRate" class="tts-dropdown">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.11/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    let isBrailleToText = true;

    const brailleTab = document.getElementById('brailleTab');
    const textTab = document.getElementById('textTab');

    const brailleTabOutput = document.getElementById('brailleToText');
    const textTabOutput = document.getElementById('textToBraille');

    const inputText = document.getElementById('inputText');
    const outputText = document.getElementById('outputText');
    const translateArrow = document.getElementById('translateArrow');

    const brfDownloadButton = document.getElementById('downloadButton');
    const keyboardButton = document.getElementById('openKeyboard');

    // 번역 방향 변경 (클릭 및 엔터 키)
    translateArrow.addEventListener('click', function () {
        changeDirection();
    });

    // 엔터 키로 번역 방향 변경
    translateArrow.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // 기본 동작 방지
            this.click(); // 클릭 이벤트 트리거
        }
    });

    function changeDirection() {
        // 상태 토글
        isBrailleToText = !isBrailleToText;

        // 입력 영역 탭 활성화 및 색상 변경
        brailleTab.classList.toggle('active', isBrailleToText);
        textTab.classList.toggle('active', !isBrailleToText);
        brailleTab.setAttribute('aria-selected', isBrailleToText);
        textTab.setAttribute('aria-selected', !isBrailleToText);

        // 출력 영역 탭 활성화 및 색상 변경
        const brailleToText = document.getElementById('brailleToText');
        const textToBraille = document.getElementById('textToBraille');
        brailleToText.classList.toggle('active', !isBrailleToText);
        textToBraille.classList.toggle('active', isBrailleToText);
        brailleToText.setAttribute('aria-selected', !isBrailleToText);
        textToBraille.setAttribute('aria-selected', isBrailleToText);

        // 입력 및 출력 플레이스홀더 전환
        inputText.placeholder = isBrailleToText
            ? "점자를 입력하세요.   또는 문서/이미지를 드래그 앤 드롭하세요."
            : "비점자를 입력하세요. 또는 문서/이미지를 드래그 앤 드롭하세요.";
        outputText.placeholder = isBrailleToText
            ? "번역 결과가 비점자로 표시됩니다."
            : "번역 결과가 점자로 표시됩니다.";

        // 입력 및 출력 값 초기화
        // 출력이 존재할 경우 입력으로 이동
        if (outputText.value) {
            inputText.value = outputText.value;
        } else {
            inputText.value = '';
        }
        outputText.value = '';

        // 버튼 업데이트
        updateImageUploadButton();
        updateDocumentUploadButton();
        updateBRFButton();
        updateTTSButton();
        updateKeyboardButton();
        closeKeyboard();
    }

    // 번역 방향 변경 (클릭 및 엔터 키)
    brailleTab.addEventListener('click', function () {
        if (!isBrailleToText) {
            changeDirection();
        }
    });
    textTab.addEventListener('click', function () {
        if (isBrailleToText) {
            changeDirection();
        }
    });
    textTabOutput.addEventListener('click', function () {
        if (!isBrailleToText) {
            changeDirection();
        }
    });
    brailleTabOutput.addEventListener('click', function () {
        if (isBrailleToText) {
            changeDirection();
        }
    });

    // 번역 버튼 동작
    document.getElementById('translateButton').addEventListener('click', function () {
        const inputValue = document.getElementById('inputText').value;

        if (!inputValue) {
            alert('입력 텍스트가 비어 있습니다.');
            return;
        }

        // 기존 음성 출력을 초기화
        stopTTS();  // 기존 음성 중지 및 UI 리셋

        // API 호출
        const endpoint = isBrailleToText ? '/translate/toText' : '/translate/toBraille';
        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(isBrailleToText ? { brailleText: inputValue } : { sourceText: inputValue }),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`번역 실패: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('outputText').value = data; // 번역 결과 출력
                resetTTS();  // 새로운 결과가 나오면 TTS 초기화
            })
            .catch(error => {
                console.error('번역 중 오류 발생:', error);
                alert(`번역 중 오류 발생: ${error.message}`);
            });
    });

    // 이미지 업로드 버튼 상태 업데이트 함수
    function updateImageUploadButton() {
        const imageUploadButton = document.getElementById('imageUploadButton'); // 고유 id로 접근
        if (imageUploadButton) {
            imageUploadButton.innerHTML = isBrailleToText
                ? '<i class="fa-regular fa-image"></i> 점자 이미지 업로드'
                : '<i class="fa-regular fa-image"></i> 비점자 이미지 업로드';
            imageUploadButton.setAttribute('aria-label', isBrailleToText
                ? '점자 이미지 파일 업로드'
                : '비점자 이미지 파일 업로드');
            // console.log("버튼 상태 업데이트 완료:", isBrailleToText ? "점자" : "비점자");
        } else {
            // console.error("이미지 업로드 버튼을 찾을 수 없습니다.");
        }
    }

    function updateBRFButton() {
        // 숨길때 위치는 유지 시켰음.
        if (isBrailleToText) {
            brfDownloadButton.style.visibility = 'hidden';
        } else {
            brfDownloadButton.style.visibility = 'visible';
        }
    }
    function updateKeyboardButton() {
        if (isBrailleToText) {
            keyboardButton.style.visibility = 'visible';
        } else {
            keyboardButton.style.visibility = 'hidden';
        }
    }

    // 사용법 버튼
    document.getElementById('helpButton').addEventListener('click', function () {
        window.open('/help', '_blank', 'width=600,height=400');
    });

    const inputTextElement = document.getElementById('inputText');

    inputTextElement.addEventListener('dragover', (event) => {
        event.preventDefault();  // 기본 동작 방지
        inputTextElement.style.backgroundColor = "#e0e0e0";  // 드래그 중 배경색 변경
    });

    // 드래그 종료 후 배경색 원래대로
    inputTextElement.addEventListener('dragleave', () => {
        inputTextElement.style.backgroundColor = "";
    });

    // 파일 드랍시 이벤트
    inputTextElement.addEventListener('drop', (event) => {
        event.preventDefault();  // 기본 동작 방지
        inputTextElement.style.backgroundColor = "";  // 배경색 원래대로
        const file = event.dataTransfer.files[0];  // 드롭된 파일 가져오기
        type = '';
        if (!file.type) {
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension === 'pdf') {
                type = 'application/pdf';  // 수동으로 텍스트 파일 타입 설정
            } else if (['hwp'].includes(fileExtension)) {
                type = 'application/x-hwp';
            } else if (['docx'].includes(fileExtension)) {
                type = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
            } else if (['brf', 'text'].includes(fileExtension)) {
                type = 'application/octet-stream';
            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                type = 'image/' + fileExtension;  // 이미지 파일 타입 설정
            }
        }

        // 파일이 텍스트 파일인 경우
        if (file && file.type.startsWith('application/') || type.startsWith('application/')) {
            documentUploadEvent(file);
        }
        // 파일이 이미지 파일인 경우
        else if (file && file.type.startsWith('image/') || type.startsWith('image/')) {
            imageUploadEvent(file);
        } else {
            alert("지원되지 않는 파일 형식입니다.");
        }
    });

    function imageUploadEvent(file, event) {
        // 번역 방향에 따른 Spring 컨트롤러 경로
        const endpoint = isBrailleToText
            ? '/api/brailleImg'  // 점자 이미지를 텍스트로 변환
            : '/ocr';            // OCR 작업 수행

        const formData = new FormData();
        formData.append("file", file);

        fetch(endpoint, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Spring 서버와의 통신 오류: ${response.statusText}`);
                }
                return response.json(); // JSON 응답 처리
            })
            .then(data => {
                // 번역 방향에 따라 처리 결과 출력
                if (isBrailleToText && data.braille_text) {
                    document.getElementById('inputText').value = data.braille_text; // 점자 → 텍스트
                } else if (!isBrailleToText && data.text) {
                    document.getElementById('inputText').value = data.text; // 텍스트 → 점자
                } else {
                    alert("변환 결과를 가져올 수 없습니다.");
                }
            })
            .catch(error => {
                console.error("Spring 서버 요청 중 오류 발생:", error);
                alert(`Spring 서버 요청 중 오류 발생: ${error.message}`);
            })
            .finally(() => {
                if (event) event.target.value = ""; // 파일 입력 초기화
            });
    }

    // 이미지 업로드
    document.getElementById('imageUpload').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) {
            alert("이미지를 선택해주세요.");
            return;
        }
        imageUploadEvent(file, event);
    });

    // 문서 업로드
    document.getElementById('documentUpload').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            alert(`문서 파일 선택: ${file.name}`);
        }
    });

    function documentUploadEvent(file, event) {
        // 번역 방향에 따른 서버 엔드포인트 설정
        const endpoint = isBrailleToText ? '/document/braille' : '/document/text';
        console.log(`서버로 요청 보냄: ${endpoint}`);

        const formData = new FormData();
        formData.append("file", file);

        fetch(endpoint, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`업로드 실패: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                console.log("서버 응답 데이터:", data);
                alert("문서 업로드 및 처리 완료!");
                document.getElementById('inputText').value = data;
            })
            .catch(error => {
                console.error("업로드 중 오류 발생:", error.message);
                alert(`업로드 중 오류 발생: ${error.message}`);
            })
            .finally(() => {
                if (event) event.target.value = ''; // 파일 입력 초기화
            });
    }

    // 문서 업로드
    document.getElementById('documentUpload').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) {
            console.error("파일이 선택되지 않았습니다.");
            return;
        }
        documentUploadEvent(file, event);
    });

    function updateDocumentUploadButton() {
        const documentUploadButton = document.getElementById('documentUploadButton');
        const documentUploadInput = document.getElementById('documentUpload');

        if (documentUploadButton && documentUploadInput) {
            if (isBrailleToText) {
                // 점자 → 비점자
                documentUploadButton.innerHTML = '<i class="fa-regular fa-folder-open"></i> 점자 문서 업로드';
                documentUploadButton.setAttribute('aria-label', '점자 문서 파일 업로드');
                documentUploadInput.setAttribute('accept', '.brf');
            } else {
                // 비점자 → 점자
                documentUploadButton.innerHTML = '<i class="fa-regular fa-folder-open"></i> 비점자 문서 업로드';
                documentUploadButton.setAttribute('aria-label', '비점자 문서 파일 업로드');
                documentUploadInput.setAttribute('accept', '.pdf,.hwp,.docx,.txt');
            }
        } else {
            console.error("문서 업로드 버튼 또는 입력 요소를 찾을 수 없습니다.");
        }
    }

    // BRF 다운로드 버튼
    document.getElementById('downloadButton').addEventListener('click', function () {
        const content = document.getElementById('outputText').value;
        if (!content) {
            alert('다운로드할 내용이 없습니다.');
            return;
        }

        fetch('/document/brf-download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sourceText: content })
        })
            .then(response => {
                if (!response.ok) throw new Error('BRF 변환 실패');
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'translated.brf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error("BRF 변환 오류:", error);
                alert("BRF 변환 중 오류 발생");
            });
    });

    // 음성 출력 버튼
    window.onload = function() {
        updateTTSButton();
    };

    function updateTTSButton() {
        const ttsControls = document.querySelector('.tts-controls'); // TTS 컨트롤 버튼들
        const ttsHeader = document.querySelector('.output-header'); // "번역 결과 음성 출력" 제목
        const ttsProgressBar = document.querySelector('.tts-progress-container'); // 진행 바

        if (ttsControls && ttsHeader && ttsProgressBar) {
            if (isBrailleToText) {
                ttsControls.style.display = 'flex'; // TTS 버튼 보이기
                ttsHeader.style.display = 'block'; // 제목 보이기
                ttsProgressBar.style.display = 'flex'; // 진행 바 보이기
            } else {
                ttsControls.style.display = 'none'; // TTS 버튼 숨기기
                ttsHeader.style.display = 'none'; // 제목 숨기기
                ttsProgressBar.style.display = 'none'; // 진행 바 숨기기
            }
        }
    }

    // TTS 관련 변수
    let isPlaying = false;
    let utterance = null;
    let currentPosition = 0;
    let textContent = "";
    let totalTextLength = 0;
    let currentCharIndex = 0;
    let isSeeking = false;
    let isPaused = false;
    let updateProgressInterval = null;

    // TTS 재생/정지 버튼
    document.getElementById('playPauseButton').addEventListener('click', function () {
        let text = document.getElementById('outputText').value;
        let rate = parseFloat(document.getElementById('voiceRate').value);

        if (text.trim() === "") return;

        if (isPlaying) {
            stopTTS();
        } else {
            if (isPaused) {
                resumeTTS(); // 정지한 위치에서 다시 시작
            } else {
                startTTS(text, currentPosition, rate); // 새로 시작
            }
        }
    });

    // 배속 변경
    document.getElementById('voiceRate').addEventListener('change', function () {
        let newRate = parseFloat(this.value);

        if (isPlaying) {
            // 현재 재생 중인 위치 저장 (2글자 앞에서 다시 시작)
            let tempPosition = Math.max(currentPosition - 2, 0);

            // 현재 음성을 중지하고, 새로운 배속으로 다시 재생
            window.speechSynthesis.cancel();
            startTTS(textContent, tempPosition, newRate);
        } else if (isPaused) {
            // 정지 상태에서 배속 변경하면, 다시 재생 시 반영되도록 설정
            savedRate = newRate;
        }
    });

    // TTS 시작 함수
    function startTTS(text, position, rate = null) {
        let playButton = document.getElementById('playPauseButton');
        let playIcon = playButton.querySelector('i');

        if (!isPaused) {
            window.speechSynthesis.cancel();
        }

        // 배속 값이 null이면 드롭다운에서 가져옴
        if (rate === null) {
            rate = parseFloat(document.getElementById('voiceRate').value);
        }

        // 새로운 음성 객체 생성
        utterance = new SpeechSynthesisUtterance(text.substring(position));
        utterance.rate = rate; // 배속 반영
        utterance.lang = 'ko-KR';

        currentCharIndex = position;
        currentPosition = position;
        textContent = text;
        totalTextLength = text.length;
        isPaused = false;

        // 진행률 업데이트 시작
        updateProgressUI();
        startProgressUpdater();

        // 음성 종료 시 stopTTS() 호출
        utterance.onend = function () {
            stopTTS();
        };

        // 음성 재생
        window.speechSynthesis.speak(utterance);
        isPlaying = true;

        // 버튼 아이콘 변경 (재생 → 정지)
        playIcon.classList.remove("fa-play");
        playIcon.classList.add("fa-stop");
    }

    // TTS 정지 함수
    function stopTTS() {
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.pause();
            isPlaying = false;
            isPaused = true;

            if (updateProgressInterval) {
                clearInterval(updateProgressInterval);
                updateProgressInterval = null;
            }
            updateButtonIcon(false);
        }
    }

    // TTS 다시 재생 함수
    function resumeTTS() {
        if (!textContent || currentPosition >= textContent.length) return; // 번역된 텍스트가 없거나 끝에 도달했으면 종료
        let newRate = parseFloat(document.getElementById('voiceRate').value); // 현재 선택한 배속 가져오기
        window.speechSynthesis.cancel();
        utterance = new SpeechSynthesisUtterance(textContent.substring(currentPosition));
        utterance.rate = newRate; // 변경된 배속 적용
        utterance.lang = 'ko-KR';

        utterance.onend = function () {
            stopTTS();
        };

        // 새롭게 재생
        window.speechSynthesis.speak(utterance);
        isPlaying = true;
        isPaused = false;

        // UI 업데이트
        updateButtonIcon(true);
        startProgressUpdater();
    }

    // TTS 초기화 (완전히 정지 후 0초부터 재생)
    function resetTTS() {
        window.speechSynthesis.cancel();  // 현재 음성 중지
        isPlaying = false;
        isPaused = false;
        currentPosition = 0;
        currentCharIndex = 0;
        textContent = "";
        totalTextLength = 0;

        // UI 업데이트
        updateButtonIcon(false);
        document.getElementById("ttsSeekBar").value = 0;
        document.getElementById("ttsCurrentTime").textContent = "00:00";
        document.getElementById("ttsTotalTime").textContent = "00:00";
    }

    // 재생/정지 버튼 아이콘 업데이트
    function updateButtonIcon(playing) {
        let playButton = document.getElementById('playPauseButton');
        let playIcon = playButton.querySelector('i');
        if (playing) {
            playIcon.classList.remove("fa-play");
            playIcon.classList.add("fa-stop");
        } else {
            playIcon.classList.remove("fa-stop");
            playIcon.classList.add("fa-play");
        }
    }

    // 진행률 바 & 시간 업데이트
    function updateProgressUI() {
        let seekBar = document.getElementById("ttsSeekBar");
        let currentTimeLabel = document.getElementById("ttsCurrentTime");
        let totalTimeLabel = document.getElementById("ttsTotalTime");

        let progressPercent = Math.round((currentCharIndex / totalTextLength) * 100);
        seekBar.value = progressPercent;

        currentTimeLabel.textContent = formatTime(currentCharIndex);
        totalTimeLabel.textContent = formatTime(totalTextLength);
    }

    // 진행률 업데이트 타이머 실행
    function startProgressUpdater() {
        if (updateProgressInterval) clearInterval(updateProgressInterval);
        updateProgressInterval = setInterval(() => {
            if (window.speechSynthesis.speaking) {
                currentCharIndex += 6; // 대략 6글자가 1초에 해당
                updateProgressUI();
            } else {
                clearInterval(updateProgressInterval);
                updateProgressInterval = null;
            }
        }, 1000);
    }

    // 텍스트 길이를 시간 형식으로 변환 (예: 00:15)
    function formatTime(charCount) {
        let seconds = Math.floor(charCount / 6); // 6글자 ≈ 1초
        let minutes = Math.floor(seconds / 60);
        seconds = seconds % 60;
        return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }

    // 사용자가 진행 바를 조작하면 해당 위치에서 재생
    document.getElementById("ttsSeekBar").addEventListener("input", function (event) {
        isSeeking = true;
        let seekPercent = event.target.value / 100;
        let newCharIndex = Math.round(seekPercent * totalTextLength);
        document.getElementById("ttsCurrentTime").textContent = formatTime(newCharIndex);
    });

    // 스크럽 바 변경 후 손을 떼면 해당 위치에서 재생
    document.getElementById("ttsSeekBar").addEventListener("change", function (event) {
        isSeeking = false;
        let seekPercent = event.target.value / 100;
        let newCharIndex = Math.round(seekPercent * totalTextLength);

        // 기존 음성 정지 후 새로운 위치에서 재생
        currentCharIndex = newCharIndex;
        startTTS(document.getElementById("outputText").value, currentCharIndex, parseFloat(document.getElementById('voiceRate').value));
    });


    // 스크럽 바 변경 후 손을 떼면 해당 위치에서 재생
    document.getElementById("ttsSeekBar").addEventListener("change", function (event) {
        isSeeking = false;
        let seekPercent = event.target.value / 100;
        let newCharIndex = Math.round(seekPercent * totalTextLength);

        // 기존 음성 정지 후 새로운 위치에서 재생
        currentCharIndex = newCharIndex;
        startTTS(document.getElementById("outputText").value, currentCharIndex, parseFloat(document.getElementById('voiceRate').value));
    });

    // 앞으로 5초 이동 버튼
    document.getElementById('skipButton').addEventListener('click', function () {
        if (!isPlaying || !utterance) return;

        // 현재 진행 중인 위치(문자 수)를 기반으로 5초 후 위치 계산
        let currentTime = currentCharIndex / 6; // 6글자 ≈ 1초
        let newTime = Math.min(currentTime + 5, totalTextLength / 6); // 5초 뒤
        let newPosition = Math.round(newTime * 6); // 6글자 ≈ 1초

        // 현재 위치 업데이트
        currentPosition = newPosition;
        currentCharIndex = newPosition;

        // 새로운 위치에서 다시 음성 재생
        startTTS(textContent, currentPosition, parseFloat(document.getElementById('voiceRate').value));
    });

    // 뒤로 5초 이동 버튼
    document.getElementById('rewindButton').addEventListener('click', function () {
        if (!isPlaying && !isPaused) return;

        // 현재 진행 중인 위치(문자 수)를 기반으로 5초 전 위치 계산
        let currentTime = currentCharIndex / 6; // 6글자 ≈ 1초
        let newTime = Math.max(currentTime - 5, 0); // 5초 전 (0초 이하로 내려가지 않도록)

        let newPosition = Math.round(newTime * 6); // 6글자 ≈ 1초

        // 현재 위치 업데이트
        currentPosition = newPosition;
        currentCharIndex = newPosition;

        // 새로운 위치에서 다시 음성 재생
        startTTS(textContent, currentPosition, parseFloat(document.getElementById('voiceRate').value));
    });

    // TTS 초기화 버튼 (Reset)
    document.getElementById('resetButton').addEventListener('click', function () {
        // 기존 음성 정지
        window.speechSynthesis.cancel();

        // 현재 읽은 위치 초기화
        currentPosition = 0;
        currentCharIndex = 0;
        isPlaying = false;

        // 버튼 상태 초기화
        let playButton = document.getElementById('playPauseButton');
        let playIcon = playButton.querySelector('i');
        playIcon.classList.remove("fa-stop");
        playIcon.classList.add("fa-play");

        // 진행률 바 및 시간 UI 즉시 초기화
        document.getElementById("ttsSeekBar").value = 0;
        document.getElementById("ttsCurrentTime").textContent = "00:00";
        document.getElementById("ttsTotalTime").textContent = formatTime(totalTextLength);

    });


    // 점자 가상 키보드
    let brailleMap = {
        "000000": " ",
        "000001": "⠠",
        "000010": "⠐",
        "000011": "⠰",
        "000100": "⠈",
        "000101": "⠨",
        "000110": "⠘",
        "000111": "⠸",
        "001000": "⠄",
        "001001": "⠤",
        "001010": "⠔",
        "001011": "⠴",
        "001100": "⠌",
        "001101": "⠬",
        "001110": "⠜",
        "001111": "⠼",
        "010000": "⠂",
        "010001": "⠢",
        "010010": "⠒",
        "010011": "⠲",
        "010100": "⠊",
        "010101": "⠪",
        "010110": "⠚",
        "010111": "⠺",
        "011000": "⠆",
        "011001": "⠦",
        "011010": "⠖",
        "011011": "⠶",
        "011100": "⠎",
        "011101": "⠮",
        "011110": "⠞",
        "011111": "⠾",
        "100000": "⠁",
        "100001": "⠡",
        "100010": "⠑",
        "100011": "⠱",
        "100100": "⠉",
        "100101": "⠩",
        "100110": "⠙",
        "100111": "⠹",
        "101000": "⠅",
        "101001": "⠥",
        "101010": "⠕",
        "101011": "⠵",
        "101100": "⠍",
        "101101": "⠭",
        "101110": "⠝",
        "101111": "⠽",
        "110000": "⠃",
        "110001": "⠣",
        "110010": "⠓",
        "110011": "⠳",
        "110100": "⠋",
        "110101": "⠫",
        "110110": "⠛",
        "110111": "⠻",
        "111000": "⠇",
        "111001": "⠧",
        "111010": "⠗",
        "111011": "⠷",
        "111100": "⠏",
        "111101": "⠯",
        "111110": "⠟",
        "111111": "⠿"
    };

    // 가상 키보드 버튼 클릭 시 팝업 열기
    document.getElementById('openKeyboard').addEventListener('click', function () {
        var dis = document.getElementById('brailleKeyboardPopup').style.display;
        if (dis != 'none' && dis != '') {
            closeKeyboard();
        } else {
            document.getElementById('brailleKeyboardPopup').style.display = 'block';
        }
    });

    // 닫기 버튼 클릭 시 팝업 닫기
    function closeKeyboard() {
        document.getElementById('brailleKeyboardPopup').style.display = 'none';
        resetBraille();
    }

    // 점자 키보드 클릭 이벤트 추가
    document.querySelectorAll('.hole').forEach(hole => {
        hole.addEventListener('click', () => {
            hole.classList.toggle('active'); // 클릭 시 색상 변경
        });
    });

    // 점자 변환 및 입력 필드(`#inputText`]에 추가
    function generateBraille() {
        let bt1 = '', bt2 = '';

        // 각 구멍의 상태에 따라 점자 형식을 생성
        let holes = document.querySelectorAll('.hole');
        for (let i = 0; i < holes.length; i++) {
            let temp;
            if (holes[i].classList.contains('active')) {
                temp = '1'; // 검정색일 경우 점자로 '1' 입력
            } else {
                temp = '0'; // 흰색일 경우 점자로 '0' 입력
            }

            // 3개씩 묶어서 한 줄로 만들어줌 (2x3 크기)
            if ((i + 1) % 2 === 1) {
                bt1 += temp;
            } else {
                bt2 += temp;
            }
        }

        let brailleCode = (bt1 + bt2).trim();
        let brailleChar = brailleMap[brailleCode] || " ";

        // 변환된 점자를 입력 필드(`#inputText`]에 삽입
        insertBraille(brailleChar);
    }

    // 입력 필드(`#inputText`]의 커서 위치에 점자 삽입
    function insertBraille(braille) {
        let textarea = document.getElementById('inputText');
        let cursorPos = textarea.selectionStart; // 현재 커서 위치 가져오기

        let text = textarea.value;

        // 입력값을 유지하면서 커서 위치에 점자 삽입
        let newText = text.slice(0, cursorPos) + braille + text.slice(cursorPos);
        textarea.value = newText;

        // 커서 위치를 삽입한 점자 다음으로 이동
        let newCursorPos = cursorPos + braille.length;
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus(); // 입력 필드에 포커스 유지
    }

    // "키보드 초기화" 버튼 클릭 시 선택된 점자 초기화
    function resetBraille() {
        document.querySelectorAll('.hole').forEach(hole => {
            hole.classList.remove('active');
        });
    }

</script>
</body>
</html>
